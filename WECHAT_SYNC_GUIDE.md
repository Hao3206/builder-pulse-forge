# 微信公众号文章同步功能使用指南

## 功能概述

本系统已集成微信公众号文章同步功能，可以将后台发布的文章自动同步到微信公众号草稿箱，方便管理员进行内容管理和发布。

## 功能特点

- ✅ 一键同步文章到微信公众号草稿箱
- ✅ 自动处理文章标题、内容、作者等信息
- ✅ 支持同步状态显示和管理
- ✅ 安全的微信公众号API集成
- ✅ 实时同步状态反馈

## 配置步骤

### 1. 获取微信公众号配置信息

1. 登录微信公众平台 (https://mp.weixin.qq.com/)
2. 进入"开发" → "基本配置"
3. 获取以下信息：
   - **AppID**: 公众号的唯一标识
   - **AppSecret**: 公众号的密钥（需要点击"重置"按钮获取）

### 2. 配置系统

1. 登录管理后台
2. 进入"微信配置"页面 (`/admin/wechat-config`)
3. 填写AppID和AppSecret
4. 点击"保存配置"

### 3. 配置服务器域名（重要）

在微信公众平台配置服务器域名白名单：

1. 进入"开发" → "基本配置"
2. 在"服务器域名"部分添加：
   - **request合法域名**: 你的服务器域名（如：`https://yourdomain.com`）
   - **uploadFile合法域名**: 你的服务器域名
   - **downloadFile合法域名**: 你的服务器域名

## 使用方法

### 同步单篇文章

1. 进入"资讯管理" → 选择要同步的文章 → 点击"编辑"
2. 在编辑页面右上角点击"同步到微信"按钮
3. 系统会自动将文章同步到微信公众号草稿箱
4. 同步成功后，状态会显示为"已同步到微信"

### 查看同步状态

- 在文章列表页面可以看到每篇文章的微信同步状态
- 在文章编辑页面可以看到详细的同步状态和同步时间

## 技术实现

### 后端API

- `GET /api/wechat/config` - 获取微信配置
- `POST /api/wechat/config` - 更新微信配置
- `POST /api/wechat/sync/:id` - 同步单篇文章
- `GET /api/wechat/sync-status/:id` - 获取同步状态

### 数据库表结构

```sql
-- 新闻表新增字段
ALTER TABLE news ADD COLUMN wechat_media_id TEXT;
ALTER TABLE news ADD COLUMN wechat_synced_at DATETIME;

-- 微信配置表
CREATE TABLE wechat_config (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  appId TEXT NOT NULL,
  appSecret TEXT NOT NULL,
  accessToken TEXT,
  expiresAt INTEGER
);
```

### 微信API集成

- 使用微信公众号素材管理API
- 自动获取和刷新access_token
- 支持文章草稿箱功能
- 错误处理和重试机制

## 注意事项

### 1. 权限要求

- 微信公众号需要是服务号或订阅号
- 需要开启开发者模式
- 需要有素材管理权限

### 2. 内容限制

- 文章标题不能超过64个字符
- 文章内容支持HTML格式
- 图片需要是有效的URL地址

### 3. 频率限制

- 微信API有调用频率限制
- 建议不要频繁同步同一篇文章
- 系统会自动处理access_token过期问题

### 4. 安全考虑

- AppSecret请妥善保管，不要泄露
- 建议定期更换AppSecret
- 服务器域名必须使用HTTPS

## 故障排除

### 常见问题

1. **同步失败：配置错误**
   - 检查AppID和AppSecret是否正确
   - 确认微信公众号类型和权限

2. **同步失败：网络错误**
   - 检查服务器网络连接
   - 确认微信API服务是否正常

3. **同步失败：域名未配置**
   - 在微信公众平台配置服务器域名白名单
   - 确保域名使用HTTPS协议

4. **access_token过期**
   - 系统会自动刷新，无需手动处理
   - 如果频繁过期，检查AppSecret是否正确

### 日志查看

系统会在控制台输出详细的同步日志，包括：
- 配置验证结果
- API调用状态
- 错误信息详情

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持基础的文章同步功能
- 支持微信配置管理
- 支持同步状态显示

## 技术支持

如有问题，请联系技术支持团队或查看系统日志获取详细错误信息。

